# /etc/fail2ban/action.d/cloudflare-challenge.conf
[Definition]

# Required variables
cf_api_token = <your Cloudflare API token>
cf_zone_id = <your Cloudflare zone id> # Get from Cloudflare dashboard site Overview -> API -> Zone ID

_curl_opts = --fail --silent --show-error --connect-timeout 5 --max-time 20 --retry 2 -H "Authorization: Bearer %(cf_api_token)s" -H "User-Agent: fail2ban-cloudflare/1.0"
_zone_uri = https://api.cloudflare.com/client/v4/zones/%(cf_zone_id)s/firewall/access_rules/rules

# Helper: find rule IDs for this IP in this zone
_cf_find_cmd = curl -X GET %(_curl_opts)s  "%(_zone_uri)s?configuration_target=ip&configuration_value=<ip>&per_page=100"

# No-ops
actionstart =
actionstop  =
actioncheck = /bin/true

# Ban: create Managed Challenge access rule (zone-scoped)
actionban = curl -X POST %(_curl_opts)s  -H "Content-Type: application/json"  --data '{"mode":"managed_challenge","configuration":{"target":"ip","value":"<ip>"},"notes":"fail2ban jail=%(name)s"}' "%(_zone_uri)s" >/dev/null

# Unban: remove every matching rule created by this jail for this IP
actionunban = %(_cf_find_cmd)s | jq -r --arg n "jail=%(name)s" '.result[] | select(.notes and (.notes|contains($n))) | .id' | xargs -r -n1 -I{} curl -X DELETE %(_curl_opts)s "%(_zone_uri)s/{}" >/dev/null || true

[Init]
init = type jq >/dev/null 2>&1 || { echo "jq is required"; exit 1; }
