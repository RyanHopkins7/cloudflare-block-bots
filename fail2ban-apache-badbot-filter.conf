# /etc/fail2ban/filter.d/apache-custom-badbots.conf
[Definition]

# ── High-signal 404s by PATH (robust) ─────────────────────────────────────
# Notes:
# - Use " [^"]* " to consume the entire quoted request (so ' HTTP/1.1' never breaks things).
# - Do not enforce HTTP version or exact spaces.
# - End by checking ' 404 ' and the size token loosely.

# Root dotfiles / VCS (.env, .git, .svn, .hg)
failregex = ^<HOST> .* "(?:GET|HEAD) /\.(?:env|git|svn|hg)(?:/[^" ]*)?[^"]*" 404 [^ ]+

# .env under common dirs
            ^<HOST> .* "(?:GET|HEAD) /(app|API|api|backend|config)/\.env[^"]*" 404 [^ ]+

# WordPress probes
            ^<HOST> .* "(?:GET|POST) /(wp-admin/setup-config\.php|xmlrpc\.php|wp-login\.php|wp-json(?:/[^" ]*)?)[^"]*" 404 [^ ]+

# Backup archives
            ^<HOST> .* "(?:GET|HEAD) /(backup|backups|bak|restore|old|public_html|www)[^"]*\.(?:zip|tar(?:\.gz)?|tgz|gz|bz2)[^"]*" 404 [^ ]+

# PHP eval/tooling
            ^<HOST> .* "(?:GET|HEAD) /(vendor/phpunit/phpunit|phpinfo\.php|info\.php|shell\.php)[^"]*" 404 [^ ]+

# Git internals (root or /config)
            ^<HOST> .* "(?:GET|HEAD) /(?:\.git(?:/config)?)[^"]*" 404 [^ ]+

# CMS admin roots (this is the one for /wp-admin etc.)
            ^<HOST> .* "(?:GET|HEAD) /(wp-admin|administrator|typo3|cms|drupal|user/login)(?:/[^" ]*)?[^"]*" 404 [^ ]+

# ── 404s with obviously bot/scanner UAs (anchor to UA field) ─────────────
# … "referrer" "User-Agent"
            ^<HOST> .* "[^"]*" 404 [^ ]+ "[^"]*" "(?i:.*(?:python-requests|python-urllib3|python|httpx|aiohttp|httplib2|curl|wget|libwww-perl|Go-http-client|okhttp|\bjava\b|sqlmap|nikto|nmap|w3af|dirbuster|zgrab|masscan|ZmEu|apachebench|HeadlessChrome|PhantomJS).*)"$

# ── Ignores ───────────────────────────────────────────────────────────────
ignoreregex = (?i)^<HOST> .* "[^"]*" "[^"]*(Googlebot|bingbot|DuckDuckBot|Applebot|YandexBot|Baiduspider|facebookexternalhit|Twitterbot|Slackbot|LinkedInBot)[^"]*"$

# Common harmless 404s (favicon, robots, sitemap, apple icons, browserconfig)
              ^<HOST> .* "(?:GET|HEAD) /(favicon\.ico|robots\.txt|sitemap\.xml|apple-touch-icon[^" ]*|browserconfig\.xml)[^"]*" 404 [^ ]+

# Blanket allow for all /.well-known/ (ACME, openpgpkey, etc.)
              ^<HOST> .* "(?:GET|HEAD) /.well-known/[^"]*" 404 [^ ]+

# Ignore common static asset paths (Grav) even if they 404 during deploys
              ^<HOST> .* "(?:GET|HEAD) /(user/(?:themes|plugins)/[^" ]+|system/assets/[^" ]+)[^"]*" 404 [^ ]+
